#include <iom48v.h>
#include <macros.h>
#include "HWFS.h"
uchar flag;
 void hongwaifashe(void)
{ 

  TCCR1B = 0x02;         //启动定时器
  BFS;				   //发射端常高电压

ZZ(0x56);
}


  void ZZ(uchar x)
{ 
  TT0(1,m9);		   //发射载波9ms
  TT0(0,m4_5);	       //不发射载波4.5mS

  /*用户码+用户反码+命令码+命令反码*/
  Z0(SBM);													                               
  Z0(~SBM);
  Z0(x);
  Z0(~x);
  TT0(1,m_56);
  TT0(0,m40);
}
/*????????????????????????????????????????????????????????????
单字节发送程序
????????????????????????????????????????????????????????????*/
void Z0(uchar temp)
{ 
  uchar v;
  for (v=0;v<8;v++)                     //循环八次数据移位 
       {     
	         TT0(1,m_56);		        //脉冲信号0.65ms      
			 if(temp&0x01) TT0(0,m1_68); //无脉冲信号1690us
			 else          TT0(0,m_56);  //无脉冲信号560us   
			 temp >>= 1;                //右移一位
        }    
}

/*????????????????????????????????????????????????????????????
1、38khz脉冲发射+延时程序
2、（是否发射脉冲：1：发射、0：不发射，延时x（us））
????????????????????????????????????????????????????????????*/
void TT0(uint BT,uint x)
{
  TCNT1H = x>>8;	            //定时器设定值高八位
  TCNT1L = x;
  TIFR1&=~0X01;			        //定时器中断标志位
  TCCR1B = 0x02;			        //启动定时器
  if(BT == 0) while(!(TIFR1&0X01));	//BT=0时不发送脉冲只延时，BT=1时发送脉冲且延时
  else {	   FS;
   	   while(!(TIFR1&0X01));
			 }
  TCCR1B =0x00;			        //关闭定时器
  TIFR1&=~0X01;		        //标志位清0

  BFS;			        //发射端常常高电压态
}
